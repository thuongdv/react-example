global
    log stdout local0
    log stdout local1 notice
    maxconn 4096
    daemon
    # Performance tuning
    tune.ssl.default-dh-param 2048
    tune.bufsize 32768
    # Compression tuning
    tune.comp.maxlevel 5

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  http-server-close
    option  forwardfor except 127.0.0.0/8
    option  redispatch
    retries 3
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    timeout http-request 10000ms
    timeout http-keep-alive 10000ms
    timeout queue 30000ms
    timeout tunnel 1h
    # Enable compression
    compression algo gzip
    compression type text/html text/plain text/css text/javascript application/javascript application/json application/xml text/xml
    # Error handling
    errorfile 400 /dev/null
    errorfile 403 /dev/null
    errorfile 408 /dev/null
    errorfile 500 /dev/null
    errorfile 502 /dev/null
    errorfile 503 /dev/null
    errorfile 504 /dev/null

frontend frontend
    bind *:8080
    
    # Stats endpoint for health checks and monitoring
    stats enable
    stats uri /haproxy-stats
    stats realm HAProxy\ Statistics
    stats refresh 30s
    stats show-legends
    stats show-node
    
    # Security headers
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Referrer-Policy strict-origin-when-cross-origin
    
    # Request logging
    capture request header Host len 64
    capture request header User-Agent len 256
    capture request header X-Forwarded-For len 64
    
    # Health check endpoint
    monitor-uri /health
    
    # Route to appropriate backend
    acl is_stats path_beg /haproxy-stats
    use_backend stats if is_stats
    default_backend backend_nginx

backend stats
    stats enable
    stats hide-version

backend backend_nginx
    balance roundrobin
    # Cookie-based session persistence
    cookie SERVERID insert indirect nocache
    # Advanced health checks
    option httpchk GET /health
    http-check expect status 200
    # Use Docker service name for local development
    server nginx nginx:80 check inter 5000ms rise 2 fall 3 cookie nginx1
    # Connection pooling
    http-reuse always

